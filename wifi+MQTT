#include <WiFi.h>
#include <MQTT.h>

const char ssid[] = "@JumboPlusIoT";
const char pass[] = "pian1234";
const char mqtt_broker[] = "test.mosquitto.org";
const char mqtt_client_id[] = "esp32AI14";
int MQTT_PORT = 1883;

const char mqtt_status[] = "group14/test1/status"; //topic สำหรับดูสถานะ
const char mqtt_mode[]   = "group14/test1/mode";
const char mqtt_modestatus[]   = "group14/test1/modestatus"; //topic สำหรับดูโหมด
const char mqtt_ldr[]    = "group14/test1/ldr"; //topic สำหรับดู LDR
const char mqtt_motor[]    = "group14/test1/motor"; //topic สำหรับดู LDR

#define LDR     32
#define LED     23
#define motor1  22
// #define motor2  18
#define BTN     19

#define LDR_TH 700

WiFiClient net;
MQTTClient client;

bool autoMode = true;      // เริ่ม Auto
bool motorState = false; 
bool autoStarted = false; // ใช้เช็คว่าเข้า Auto ใหม่หรือยัง

bool btnLast = LOW;

int ldr_value = 0;
void messageReceived(String &topic, String &payload) 
{ 
  if (topic == mqtt_mode) { //ถ้า topic ที่ส่งมาเป็นโหมดให้ทำเช็คว่าเป็น auto รึเปล่า
    autoMode = !autoMode;
    autoStarted = false;
    Serial.println("incoming: " + topic + " - " + payload);  
  } 
  if (topic == mqtt_motor && !autoMode) {  //ถ้า topic ที่ส่งมาเป็นสถานะ motor และไม่เป็นโหมด auto ให้เช็คว่าสั่งให้ motor ทำงานรึเปล่า
    motorState = !motorState; 
    Serial.println("incoming: " + topic + " - " + payload);  
    } 
}

void connect() {
  Serial.print("checking wifi..."); 
  while (WiFi.status() != WL_CONNECTED) 
  {
    Serial.print(".");  
    delay(500);
  }
  Serial.print("\nconnecting..."); 
  while (!client.connect(mqtt_client_id)) {
    Serial.print(".");  
    delay(500);
  }

  Serial.println("\nconnected!");   
  client.subscribe(mqtt_mode);
  client.subscribe(mqtt_motor);
// client.subscribe(mqtt_ldr);
// client.subscribe(mqtt_status);
// client.subscribe(mqtt_modestatus);
}

void setup() {
  Serial.begin(9600);
  WiFi.begin(ssid, pass);
  client.onMessage(messageReceived);
  pinMode(motor1, OUTPUT);
  // pinMode(motor2, OUTPUT);
  pinMode(LED, OUTPUT);
  pinMode(BTN, INPUT_PULLUP);

  client.begin(mqtt_broker, MQTT_PORT, net);
  connect();
}

void loop() {
  client.loop();
  if (!client.connected()) connect();

  /* ===== ปุ่มกด ===== */
  bool btnNow = digitalRead(BTN);

  if (!btnNow && btnLast) {
    autoMode = !autoMode; //กดปุ่มเปลี่ยนโหมด
    autoStarted = false;   // ⭐ สำคัญ
  }
  btnLast = btnNow;
  /* ===== อ่าน LDR ===== */
  ldr_value = map(analogRead(LDR),0,4095,0,1023);

  /* ===== Auto Mode Logic ===== */
  if (autoMode) {
    if (!autoStarted) {
      motorState = true;     // เข้า Auto → มอเตอร์หมุนทันที
      autoStarted = true;
      
    }
    if (ldr_value > LDR_TH) {
      motorState = true;    // หยุดเมื่อ LDR เกินค่า
    }
    else{
      motorState = false; 
    }
  }
  else{
    if(autoStarted){
      motorState = false;
      autoStarted = false;   
    }
  }

  /* ===== ควบคุมมอเตอร์จริง ===== */
  if (motorState) { //เช็คว่าmotorหมุนรึเปล่า 
    digitalWrite(motor1, HIGH);
    // digitalWrite(motor2, LOW);
    digitalWrite(LED, HIGH);
    client.publish(mqtt_status,"Working"); //ส่งข้อคว่ามว่าmotorทำงาน
  } else {
    digitalWrite(motor1, LOW);
    // digitalWrite(motor2, LOW);
    digitalWrite(LED, LOW);
    client.publish(mqtt_status,"Stop");//ส่งข้อคว่ามว่าmotorหยุด
  }

  /* ===== MQTT แสดงผล ===== */
  client.publish(mqtt_ldr, String(ldr_value)); //ส่งค่า LDR
  client.publish(mqtt_modestatus, autoMode ? "Auto" : "Manual"); // ส่งสถานะโหมด

  delay(200);
}
